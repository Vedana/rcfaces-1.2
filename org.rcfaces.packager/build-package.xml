<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="Package Camelia" default="main" basedir=".">
	<property name="dist"  value="${basedir}/dist"/>
	<property name="build"  value="${basedir}/build"/>
	<property name="build-core"  value="${basedir}/../org.rcfaces.core"/>
	<property name="build-html"  value="${basedir}/../org.rcfaces.renderkit.html"/>
	<property name="java.target"  value="1.5"/>
	
	<path id="generator.class.path">
		<fileset dir="lib-generator">
			<include name="*.jar"/>
		</fileset>
	</path>
	
	<path id="optimizer.class.path">
		<pathelement location="lib-optimizer/optimizer.jar"/>
	</path>
	
	<path id="commons.class.path">
		<pathelement location="lib/commons-logging.jar" />
		<pathelement location="lib/commons-digester.jar" />
		<pathelement location="lib/commons-collections.jar" />
	</path>
	
	<target name="clean">
		<delete dir="${build}" failonerror="false" />		
		<delete file="${dist}/rcfaces*.jar" failonerror="false" />		
		 <delete failonerror="false">
		    <fileset dir="${build-html}/src-generated/org/rcfaces/renderkit/html/internal/javascript" includes="**/*.jsc,symbolsc,symbols"/>
		    <fileset dir="${build-html}/bin/org/rcfaces/renderkit/html/internal/javascript" includes="**/*.jsc,symbolsc,symbols"/>
		  </delete>
	</target>

	<target name="compileJS" >
		<delete failonerror="false" dir="${build}/js_optimizer1" />
		<mkdir dir="${build}/js_optimizer1" />

		<java classname="com.vedana.camelia.generator.js.parser.JsOptimizer">
			<classpath refid="generator.class.path" />
			<classpath refid="optimizer.class.path" />
			<classpath refid="commons.class.path" />

			<arg value="-source"/>
            <arg path="${build-html}/src/org/rcfaces/renderkit/html/internal/javascript/" />

			<arg value="-dest"/>
			<arg path="${build}/js_optimizer1/org/rcfaces/renderkit/html/internal/javascript" />

			<arg value="-extension"/>
			<arg value="js" />

			<arg value="-label"/>
			<arg value="LEVEL1" />

			<arg value="-version"/>
			<arg value="I${build.number}" />

		</java>
		
		<delete failonerror="false" dir="${build}/js_optimizer2" />
		<mkdir dir="${build}/js_optimizer2" />

		<java classname="com.vedana.camelia.generator.js.parser.JsOptimizer">
			<classpath refid="generator.class.path" />
			<classpath refid="optimizer.class.path" />
			<classpath refid="commons.class.path" />

			<arg value="-source"/>
            <arg path="${build-html}/src/org/rcfaces/renderkit/html/internal/javascript/" />

			<arg value="-dest"/>
			<arg path="${build}/js_optimizer2/org/rcfaces/renderkit/html/internal/javascript" />

			<arg value="-label"/>
			<arg value="LEVEL2" />

			<arg value="-extension"/>
			<arg value="js" />

			<arg value="-version"/>
			<arg value="I${build.number}" />
			
			<arg value="+mergeVariables" />
			<arg value="+resolveSuper" />
			<arg value="+inlineAspects" />

		</java>
		
		<delete failonerror="false" dir="${build}/js_optimizer3" />
		<mkdir dir="${build}/js_optimizer3" />

		<java classname="com.vedana.camelia.generator.js.parser.JsOptimizer">
			<classpath refid="generator.class.path" />
			<classpath refid="optimizer.class.path" />
			<classpath refid="commons.class.path" />

			<arg value="-source"/>
            <arg path="${build-html}/src/org/rcfaces/renderkit/html/internal/javascript/" />

			<arg value="-dest"/>
			<arg path="${build}/js_optimizer3/org/rcfaces/renderkit/html/internal/javascript" />

			<arg value="-label"/>
			<arg value="LEVEL3" />

			<arg value="-extension"/>
			<arg value="js" />

			<arg value="-version"/>
			<arg value="I${build.number}" />
			
			<arg value="+mergeVariables" />
			<arg value="+resolveSuper" />
			<arg value="+inlineAspects" />
			<arg value="+multiWindow" />

		</java>
 	</target>

	<target name="main" unless="builtMain">
		<property name="builtMain" value="true"/>

		<antcall target="clean" />

		<delete dir="${dist}/last" failonerror="false" />		
		
		<echo message="dir ${dist}" />
		<buildnumber file="${dist}/build-number"/>
		<tstamp>
			<format property="TODAY" pattern="dd/MM/yyyy HH:mm " locale="fr"/>
		</tstamp>

		<antcall target="compileJS" />

		<property name="rcfaces-tlddoc.zip" value="${dist}/last/rcfaces-tlddoc.zip" />
		<property name="rcfaces-jsdoc.zip" value="${dist}/last/rcfaces-jsdoc.zip" />
	</target>
	
	<target name="integration">
		<property name="integration.version" value="-I${build.number}" />
		<property name="buildNumber.path" value="${dist}/rcfaces${integration.version}" />

		<mkdir dir="${buildNumber.path}"/>
		<copy todir="${buildNumber.path}">
			<fileset dir="${dist}/last">
				<include name="*.jar"/>
			</fileset>
			<mapper type="glob" from="*.jar" to="*${integration.version}.jar"/>
		</copy>
		<copy todir="${buildNumber.path}">
			<fileset dir="${dist}/last">
				<include name="*.zip"/>
			</fileset>
			<mapper type="glob" from="*.zip" to="*${integration.version}.zip"/>
		</copy>
	</target>
	
	<target name="tlddoc">
		<delete failonerror="false" dir="${build}/camelia-tlddoc" />
		<mkdir dir="${build}/camelia-tlddoc" />
		<java classname="com.sun.tlddoc.TLDDoc">
			<classpath location="lib/tlddoc-1.3.jar" />
			<arg value="-d"/>
			<arg path="${build}/camelia-tlddoc"/>
			<arg path="${build-core}/src-jsf1_1-generated/org/rcfaces/core/rcfaces-core.tld"/>
			<arg path="${build-html}/src-jsf1_1-generated/org/rcfaces/renderkit/html/rcfaces-html.tld"/>
		 </java>
		<zip destfile="${rcfaces-tlddoc.zip}">
			<fileset dir="${build}/camelia-tlddoc">
			</fileset>
		</zip>
	</target>
	
	<target name="jsdoc">
		<taskdef name="jsDoc" classname="com.vedana.js.doc.ant.JsDoc">
			<classpath location="lib/jsdoc.jar" />
		</taskdef>
		<delete failonerror="false" dir="${build}/camelia-jsdoc" />
		<mkdir dir="${build}/camelia-jsdoc" />
		<jsDoc 
		  	product="camelia" 
		  	format="html"
			scope="public"
		  	input="${build-html}/src/org/rcfaces/renderkit/html/internal/javascript"
		  	outputDirectory="${build}/camelia-jsdoc/">
		</jsDoc>
		<zip destfile="${rcfaces-jsdoc.zip}">
			<fileset dir="${build}/camelia-jsdoc">
			</fileset>
		</zip>
	</target>

	<target name="build1_1" depends="main">
		<ant antfile="build-package.xml" target="buildVersion">
			<property name="jsf.version" value="1_1"  />
			<property name="jsf.version.manifest" value="1.1"/>
			<property name="generator.classname" value="com.vedana.camelia.generator.components_1_1.CameliaGenerator"/>
			<property name="version" value="1.1" />
			<property name="minorRelease" value="0" />
		</ant>
	</target>

	<target name="build1_2" depends="main">
		<ant antfile="build-package.xml" target="buildVersion">
			<property name="jsf.version" value="1_2"  />
			<property name="jsf.version.manifest" value="1.2"/>
			<property name="generator.classname" value="com.vedana.camelia.generator.components_1_2.CameliaGenerator1_2"/>
			<property name="version" value="1.2" />
			<property name="minorRelease" value="0" />
		</ant>
	</target>

	<target name="buildVersion" >
		<property name="build.path" value="${dist}/last" />

		<property name="build.version.path" value="${build}/${jsf.version}" />
		
		<property name="rcfaces-core.jar" value="${build.path}/rcfaces-core-jsf${jsf.version}.jar" />
		<property name="rcfaces-core-src.jar" value="${build.path}/rcfaces-core-src-jsf${jsf.version}.jar" />		
		<property name="rcfaces-html.jar" value="${build.path}/rcfaces-html-jsf${jsf.version}.jar" />
		<property name="rcfaces-htmlc1.jar" value="${build.path}/rcfaces-htmlc-jsf${jsf.version}.jar" />
		<property name="rcfaces-htmlc2.jar" value="${build.path}/rcfaces-htmlc2-jsf${jsf.version}.jar" />
		<property name="rcfaces-htmlc3.jar" value="${build.path}/rcfaces-htmlc3-jsf${jsf.version}.jar" />
		<property name="rcfaces-html-src.jar" value="${build.path}/rcfaces-html-src-jsf${jsf.version}.jar" />
		<property name="rcfaces-javadoc.zip" value="${build.path}/rcfaces-javadoc-jsf${jsf.version}.zip" />

		<mkdir dir="${build.path}" />

		<delete failonerror="false" dir="${build.version.path}">
		</delete>
		<mkdir dir="${build.version.path}" />
		
		<mkdir dir="${build.version.path}/src-core" />
		<mkdir dir="${build.version.path}/bin-core" />
		
		<copy todir="${build.version.path}/src-core">
			<fileset dir="${build-core}/src">
				<include name="**/*.java" />
				<include name="**/*.properties" />
				<include name="**/*.xml" />
			</fileset>
			<fileset dir="${build-core}/src-jsf${jsf.version}">
				<include name="**/*.java" />
			</fileset>
			<fileset dir="${build-core}/src-jsf${jsf.version}-generated">
				<include name="**/*.java" />
			</fileset>
		</copy>

		<copy file="${build-core}/META-INF/MANIFEST.MF" toDir="${build.version.path}/src-core/META-INF" overwrite="true"/>
		<manifest file="${build.version.path}/src-core/META-INF/MANIFEST.MF" mode="update">
			<attribute name="Specification-Version" value="${version}"/> 
			<attribute name="Implementation-Version" value="${version}.${minorRelease}.${build.number}"/> 
	    	<attribute name="Build-Date" value="${TODAY}"/>
	    	<attribute name="Jsf-version" value="${jsf.version.manifest}"/>
			<section name="org.rcfaces.core">
			</section>
		</manifest>

		<copy 
			file="${build-core}/src-jsf${jsf.version}-generated/org/rcfaces/core/rcfaces-core-facesconfig.xml" 
			tofile="${build.version.path}/src-core/META-INF/faces-config.xml"/>
		<copy 
			file="${build-core}/src-jsf${jsf.version}-generated/org/rcfaces/core/rcfaces-core.taglib.xml" 
			tofile="${build.version.path}/src-core/META-INF/rcfaces-core.taglib.xml"/>
		<copy 
			file="${build-core}/src-jsf${jsf.version}-generated/org/rcfaces/core/rcfaces-core.tld" 
			tofile="${build.version.path}/src-core/META-INF/rcfaces-core.tld"/>
		<copy 
			file="${build-core}/src/org/rcfaces/core/internal/images/ico/javax.imageio.spi.ImageWriterSpi" 
			tofile="${build.version.path}/src-core/META-INF/services/javax.imageio.spi.ImageWriterSpi"/>

		<copy todir="${build.version.path}/bin-core">
			<fileset dir="${build.version.path}/src-core">
				<exclude name="**/*.java" />
			</fileset>
		</copy>

		<!-- Une premiere compile -->		
		<javac srcdir="${build.version.path}/src-core" debug="true" destdir="${build.version.path}/bin-core" optimize="no" target="${java.target}" encoding="utf-8" failonerror="false">
			<classpath>
				<fileset dir="${build-core}/lib">
					<include name="*.jar"/>
				</fileset>
				<fileset dir="${build-core}/lib/jsf${jsf.version}">
					<include name="*.jar"/>
				</fileset>
			</classpath>
		</javac>

		<path id="generated.classpath">
		    <pathelement path="${build.version.path}/bin-core"/>
			<fileset dir="${build-core}/lib">
				<include name="*.jar"/>
			</fileset>
			<fileset dir="${build-core}/lib/jsf${jsf.version}">
				<include name="*.jar"/>
			</fileset>
		</path>

		<echo message="Call generator ${generator.classname}" />
		<java classname="${generator.classname}">
			<classpath refid="generator.class.path" />
			
			<arg path="lib-generator"/>
			<arg pathref="generated.classpath"/>
			<arg path="${build-core}/src-jsf${jsf.version}-generated"/>
			<arg path="${build-html}/src-jsf${jsf.version}-generated"/>
		</java>
		
		<javac srcdir="${build.version.path}/src-core" debug="true" destdir="${build.version.path}/bin-core" optimize="no" target="${java.target}" encoding="utf-8">
			<classpath>
				<fileset dir="${build-core}/lib">
					<include name="*.jar"/>
				</fileset>
				<fileset dir="${build-core}/lib/jsf${jsf.version}">
					<include name="*.jar"/>
				</fileset>
			</classpath>
		</javac>

		<delete file="${rcfaces-core.jar}" failonerror="false" />
		<jar destfile="${rcfaces-core.jar}" index="true" manifest="${build.version.path}/bin-core/META-INF/MANIFEST.MF">
			<fileset dir="${build.version.path}/bin-core">
			</fileset>
		</jar>
		
		<delete file="${rcfaces-core-src.jar}" failonerror="false" />
		<jar destfile="${rcfaces-core-src.jar}" index="true" manifest="${build.version.path}/src-core/META-INF/MANIFEST.MF">
			<fileset dir="${build.version.path}/src-core">
			</fileset>
		</jar>

		<!-- ############################ LE HTML   ################################## -->
		
		<mkdir dir="${build.version.path}/src-html" />

		<mkdir dir="${build.version.path}/bin-html" />
		<mkdir dir="${build.version.path}/bin-htmlc" />
	
		
		<copy todir="${build.version.path}/src-html">
			<fileset dir="${build-html}/src">
				<exclude name="**/*.db"/>
				<exclude name="**/*_"/>
			</fileset>
			<fileset dir="${build-html}/src-jsf${jsf.version}">
			</fileset>
			<fileset dir="${build-html}/src-generated">
				<exclude name="**/*.jsc"/>
				<exclude name="**/symbols"/>
			</fileset>
			<fileset dir="${build-html}/src-jsf${jsf.version}-generated">
				<exclude name="org/rcfaces/renderkit/html/*.tld"/>
				<exclude name="org/rcfaces/renderkit/html/*.xml"/>
			</fileset>
		</copy>


		<copy 
			file="${build-html}/src-jsf${jsf.version}-generated/org/rcfaces/renderkit/html/rcfaces-html-facesconfig.xml" 
			tofile="${build.version.path}/src-html/META-INF/faces-config.xml"/>
		<copy 
			file="${build-html}/src-jsf${jsf.version}-generated/org/rcfaces/renderkit/html/rcfaces-html.taglib.xml" 
			tofile="${build.version.path}/src-html/META-INF/rcfaces-html.taglib.xml"/>
		<copy 
			file="${build-html}/src-jsf${jsf.version}-generated/org/rcfaces/renderkit/html/rcfaces-html.tld" 
			tofile="${build.version.path}/src-html/META-INF/rcfaces-html.tld"/>
		<copy 
			file="${build-html}/src/org/rcfaces/renderkit/html/internal/rcfaces-html-config.xml" 
			tofile="${build.version.path}/src-html/META-INF/rcfaces-config.xml"/>

		<copy file="${build-html}/META-INF/MANIFEST.MF" toDir="${build.version.path}/src-html/META-INF" overwrite="true"/>
		<manifest file="${build.version.path}/src-html/META-INF/MANIFEST.MF" mode="update">
			<attribute name="Specification-Version" value="${version}"/> 
			<attribute name="Implementation-Version" value="${version}.${minorRelease}.${build.number}"/> 
	    	<attribute name="Build-Date" value="${TODAY}"/>
	    	<attribute name="Jsf-version" value="${jsf.version.manifest}"/>
			<section name="org.rcfaces.renderkit.html">
			</section>
		</manifest>

		<javac srcdir="${build.version.path}/src-html" debug="true" destdir="${build.version.path}/bin-html" optimize="no" target="${java.target}" encoding="utf-8">
			<classpath>
				<fileset dir="${build-core}/lib">
					<include name="*.jar"/>
				</fileset>
				<fileset dir="${build-core}/lib/jsf${jsf.version}">
					<include name="*.jar"/>
				</fileset>
				<fileset dir="${build-html}/lib">
					<include name="*.jar"/>
				</fileset>
				<path path="${build.version.path}/bin-core" />
			</classpath>
		</javac>
		
		<copy todir="${build.version.path}/bin-html">
			<fileset dir="${build.version.path}/src-html">
				<exclude name="**/*.java"/>
			</fileset>
		</copy>

		<delete file="${rcfaces-html.jar}" failonerror="false" />
		<jar destfile="${rcfaces-html.jar}" index="true" manifest="${build.version.path}/bin-html/META-INF/MANIFEST.MF">
			<fileset dir="${build.version.path}/bin-html">
			</fileset>
		</jar>
		
		<delete file="${rcfaces-html-src.jar}" failonerror="false" />
		<jar destfile="${rcfaces-html-src.jar}" index="true" manifest="${build.version.path}/src-html/META-INF/MANIFEST.MF">
			<fileset dir="${build.version.path}/src-html">
			</fileset>
		</jar>
		
		<delete file="{build.version.path}/bin-htmlc1" failonerror="false" />
		<copy todir="${build.version.path}/bin-htmlc1" includeemptydirs="no">
			<fileset dir="${build.version.path}/bin-html">
				<exclude name="**/*.js"/>
				<exclude name="**/symbols" />
				<exclude name="**/*old"/>
			</fileset>
			
			<fileset dir="${build}/js_optimizer1">
			</fileset>			
		</copy>
		<manifest file="${build.version.path}/bin-htmlc1/META-INF/MANIFEST.MF" mode="update">
			<section name="org.rcfaces.renderkit.html">
				<attribute name="Rcfaces-Javascript-Level" value="1"/> 
			</section>
		</manifest>

		<delete file="${rcfaces-htmlc1.jar}" failonerror="false" />
		<jar destfile="${rcfaces-htmlc1.jar}" index="true" manifest="${build.version.path}/bin-htmlc1/META-INF/MANIFEST.MF">
			<fileset dir="${build.version.path}/bin-htmlc1">
			</fileset>
		</jar>
		
		<delete file="{build.version.path}/bin-htmlc2" failonerror="false" />
		<copy todir="${build.version.path}/bin-htmlc2" includeemptydirs="no">
			<fileset dir="${build.version.path}/bin-html">
				<exclude name="**/*.js"/>
				<exclude name="**/symbols" />
				<exclude name="**/*old"/>
			</fileset>
			
			<fileset dir="${build}/js_optimizer2">
			</fileset>			
		</copy>
		<manifest file="${build.version.path}/bin-htmlc2/META-INF/MANIFEST.MF" mode="update">
			<section name="org.rcfaces.renderkit.html">
				<attribute name="Rcfaces-Javascript-Level" value="2"/> 
			</section>
		</manifest>

		<delete file="${rcfaces-htmlc2.jar}" failonerror="false" />
		<jar destfile="${rcfaces-htmlc2.jar}" index="true" manifest="${build.version.path}/bin-htmlc2/META-INF/MANIFEST.MF">
			<fileset dir="${build.version.path}/bin-htmlc2">
			</fileset>
		</jar>
		
		<delete file="{build.version.path}/bin-htmlc3" failonerror="false" />
		<copy todir="${build.version.path}/bin-htmlc3" includeemptydirs="no">
			<fileset dir="${build.version.path}/bin-html">
				<exclude name="**/*.js"/>
				<exclude name="**/symbols" />
				<exclude name="**/*old"/>
			</fileset>
			
			<fileset dir="${build}/js_optimizer3">
			</fileset>			
		</copy>
		<manifest file="${build.version.path}/bin-htmlc3/META-INF/MANIFEST.MF" mode="update">
			<section name="org.rcfaces.renderkit.html">
				<attribute name="Rcfaces-Javascript-Level" value="3"/> 
			</section>
		</manifest>

		<delete file="${rcfaces-htmlc3.jar}" failonerror="false" />
		<jar destfile="${rcfaces-htmlc3.jar}" index="true" manifest="${build.version.path}/bin-htmlc3/META-INF/MANIFEST.MF">
			<fileset dir="${build.version.path}/bin-htmlc3">
			</fileset>
		</jar>

		<!-- ############################ JAVADOC ################################## -->


		<mkdir dir="${build.version.path}/javadoc" />
		<javadoc access="public" 
			 	encoding="utf-8"
				author="false" 
				destdir="${build.version.path}/javadoc" 
				doctitle="Rich Client Faces Components" 
				nodeprecated="true" 
				nodeprecatedlist="true" 
				noindex="false" 
				nonavbar="false" 
				notree="false" 
				packagenames="org.rcfaces.core.component.capability,org.rcfaces.core.converter,org.rcfaces.core.component.familly,org.rcfaces.core.component,org.rcfaces.core.component.iterator,org.rcfaces.core.event,org.rcfaces.core.util,org.rcfaces.core.model,org.rcfaces.core.preference,org.rcfaces.core.provider,org.rcfaces.core.progressMonitor,org.rcfaces.core.image,org.rcfaces.core.item,org.rcfaces.core.lang,org.rcfaces.core.lang.provider" 
				source="${java.target}" 
				sourcepath="${build.version.path}/src-core" 
				splitindex="true" 
				use="false" 
				version="false">
			<classpath>
				<fileset dir="${build-core}/lib">
					<include name="*.jar"/>
				</fileset>
				<fileset dir="${build-core}/lib/jsf${jsf.version}">
					<include name="*.jar"/>
				</fileset>
			</classpath>
		</javadoc>
		<zip destfile="${rcfaces-javadoc.zip}">
			<fileset dir="${build.version.path}/javadoc">
			</fileset>
		</zip>

	</target>
	
	<target name="setup1_1">
		<copy file="${build-core}/.classpath-1_1" tofile="${build-core}/.classpath" overwrite="true" />
		<copy file="${build-html}/.classpath-1_1" tofile="${build-html}/.classpath" overwrite="true" />
	</target>
	
	<target name="setup1_2">
		<copy file="${build-core}/.classpath-1_2" tofile="${build-core}/.classpath" overwrite="true" />
		<copy file="${build-html}/.classpath-1_2" tofile="${build-html}/.classpath" overwrite="true" />
	</target>

</project>